{{ self.title() }}

- **首先考虑判断一个序列 $a$ 的值能否 $\ge x$。**

将 $a$ 中 $\ge x$ 的数替换为 $1$，$<x$ 的数替换为 $0$，则每次操作就是将选定区间中的所有数均替换为它们的众数（即 $1$ 多换为 $1$，$0$ 多换为 $0$），而我们的目标是将 $a$ 中所有数变为 $1$。

容易发现，当且仅当 $a$ 中存在两个 $1$ 的下标差 $\le 2$ 时，存在可将 $a$ 中所有数变为 $1$ 的方案。

- **接下来计算值 $\ge x$ 的序列个数，记之为 $c_x$。**

运用补集转换的思想，我们可以计算出不存在两个 $1$ 的下标差 $\le 2$（即任意两个 $1$ 的下标差 $>2$）的序列个数 $c_x'$，则 $c_x=\prod\limits_{i=1}^n(r_i-l_i+1)-c_x'$。

考虑使用动态规划求解 $c_x'$。

令 $f_{i,0/1/2}$ 表示仅考虑序列中前 $i$ 个数，且第 $i$ 位和第 $i-1$ 位分别 $(<x,<x)/(<x,\ge x)/(\ge x,<x)$ 的 $c_x'$ 的值，则转移方程为：

$$\begin{cases}f_{i,0}=(f_{i-1,0}+f_{i-1,1})\cdot \max(0,\min(x-1,r_i)-l_i+1)\\f_{i,1}=f_{i-1,2}\cdot \max(0,\min(x-1,r_i)-l_i+1)\\f_{i,2}=f_{i-1,0}\cdot \max(0,r_i-min(x,l_i)+1)\end{cases}$$

则 $c_x'=f_{i,0}+f_{i,1}+f_{i,2}$，$c_x=\prod\limits_{i=1}^n(r_i-l_i+1)-(f_{i,0}+f_{i,1}+f_{i,2})$。

（当然这里也可不用补集转换直接动态规划求解 $c_x$，但状态会多出一维。）

- **回到原问题。**

可以发现，值恰好等于 $x$ 的序列个数为 $c_x-c_{x+1}$，故所求即为 $\sum\limits_{x=1}^m(c_x-c_{x+1})\cdot x=\sum\limits_{x=1}^mc_x$。

分别求出 $c_1,c_2,\dots,c_m$ 并求和即可，时间复杂度 $O(Tnm)$。

- **考虑优化。**

令 $p$ 为 $l,r$ 拼接在一起升序排序后的序列，特别地，令 $p_0=0$。

则我们可以证明：$\forall\ 0\le i<n$，$c_{p_i+1},c_{p_i+2},\dots,c_{p_{i+1}}$ 为一个不超过 $n$ 次多项式 $f(x)$ 的 $p_{i+1}-p_i$ 个点值 $f(0),f(1),\ldots,f(p_{i+1}-p_i-1)$。

进而，我们得到：$\forall\ 0\le i<n$，$c_{p_i+1},(c_{p_i+1}+c_{p_i+2}),\dots,(c_{p_i+1}+c_{p_i+2}+\dots+c_{p_{i+1}})$ 为一个不超过 $n+1$ 次多项式 $f'(x)$ 的 $p_{i+1}-p_i$ 个点值 $f'(0),f'(1),\ldots,f'(p_{i+1}-p_i-1)$。

因此，当 $p_{i+1}-p_i>n+2$ 时，我们可以仅计算出 $c_{p_i+1},(c_{p_i+1}+c_{p_i+2}),\dots,(c_{p_i+1}+c_{p_i+2}+\dots+c_{p_{i+1}})$ 中前 $n+2$ 项的值，最后使用拉格朗日插值计算出 $c_{p_i+1}+c_{p_i+2}+\dots+c_{p_{i+1}}$。

时间复杂度 $O(Tn^3)$。
